<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecetaPp | Preparación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfd; }
        .font-serif { font-family: 'Playfair Display', serif; }
        /* Efecto de tachado cuando el checkbox está marcado */
        .checkbox-custom:checked + span { text-decoration: line-through; color: #94a3b8; opacity: 0.7; }
    </style>
    <script>
        function generarSchemaJSONLD(receta) {
    // Eliminamos cualquier esquema previo si existiera
    const oldScript = document.getElementById('recipe-schema');
    if (oldScript) oldScript.remove();

    // Estructuramos el objeto siguiendo el estándar de Schema.org
    const schema = {
        "@context": "https://schema.org/",
        "@type": "Recipe",
        "name": receta.titulo,
        "image": [
            `https://img.youtube.com/vi/${receta.video_id}/maxresdefault.jpg`,
            `https://img.youtube.com/vi/${receta.video_id}/hqdefault.jpg`
        ],
        "author": {
            "@type": "Organization",
            "name": "RebitesUK"
        },
        "description": receta.descripcion || `Aprende cómo preparar ${receta.titulo} de forma fácil y rápida.`,
        "recipeCategory": receta.categoria,
        "recipeCuisine": receta.pais || "Global",
        "prepTime": "PT10M", // Valores por defecto si no están en tu JSON
        "cookTime": "PT20M",
        "totalTime": "PT30M",
        "keywords": `${receta.categoria}, cocina, receta fácil, ${receta.pais}`,
        "recipeIngredient": receta.ingredientes || [],
        "recipeInstructions": receta.pasos_clave.map((paso, index) => {
            return {
                "@type": "HowToStep",
                "name": `Paso ${index + 1}`,
                "text": paso
            };
        }),
        "video": {
            "@type": "VideoObject",
            "name": receta.titulo,
            "description": receta.descripcion,
            "thumbnailUrl": `https://img.youtube.com/vi/${receta.video_id}/hqdefault.jpg`,
            "contentUrl": `https://www.youtube.com/watch?v=${receta.video_id}`,
            "embedUrl": `https://www.youtube.com/embed/${receta.video_id}`,
            "uploadDate": "2024-01-01T08:00:00+08:00" // Puedes dinamizar esto si tienes la fecha
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": receta.popularidad || "4.8",
            "reviewCount": "85"
        }
    };

    // Crear el elemento script e inyectarlo en el HEAD
    const script = document.createElement('script');
    script.id = 'recipe-schema';
    script.type = 'application/ld+json';
    script.text = JSON.stringify(schema);
    document.head.appendChild(script);
    
    console.log("✅ Schema JSON-LD inyectado para Google Adsense");
}
    </script>
</head>
<body class="text-slate-900">

    <nav class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
                <i data-lucide="chevron-left" class="text-orange-500"></i>
                <span class="font-bold">Volver</span>
            </div>
            <span class="text-xl font-extrabold">Receta<span class="text-orange-500 italic">Pp</span></span>
        </div>
    </nav>

    <main class="pt-32 pb-24 px-6 max-w-5xl mx-auto">
        <header class="mb-12">
            <span id="categoriaReceta" class="text-orange-600 font-bold uppercase tracking-widest text-xs bg-orange-50 px-3 py-1 rounded-full">Categoría</span>
            <h1 id="tituloReceta" class="text-5xl font-serif mt-4 mb-6 leading-tight text-slate-900">Cargando receta...</h1>
            <p id="descripcionReceta" class="text-lg text-slate-500 max-w-2xl mb-8">...</p>
            
            <div class="flex flex-wrap gap-8 text-slate-400 border-y border-slate-100 py-6">
                <div class="flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i> <span id="paisReceta" class="text-slate-700 font-semibold"></span></div>
                <div class="flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i> <span id="tiempoReceta" class="text-slate-700 font-semibold"></span></div>
                <div class="flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> <span id="dificultadReceta" class="text-slate-700 font-semibold"></span></div>
            </div>
        </header>

        <div class="grid lg:grid-cols-3 gap-16 mb-20">
            <aside class="lg:col-span-1">
                <h3 class="text-2xl font-serif mb-8 flex items-center gap-2">
                    <i data-lucide="list-checks" class="text-orange-500"></i> Lista de Compra
                </h3>
                <div id="listaIngredientes" class="space-y-4"></div>
            </aside>

            <section class="lg:col-span-2">
                <h3 class="text-2xl font-serif mb-8 flex items-center gap-2">
                    <i data-lucide="flame" class="text-orange-500"></i> Paso a Paso
                </h3>
                <div id="listaPasos" class="space-y-10"></div>
            </section>
        </div>

        <section class="border-t border-slate-100 pt-16">
            <h3 class="text-2xl font-serif mb-8 text-center">Creditos Tutorial Completo</h3>
            <div class="relative aspect-video rounded-[3rem] overflow-hidden shadow-2xl bg-slate-200">
                <iframe id="videoFrame" class="absolute inset-0 w-full h-full" frameborder="0" allowfullscreen src="about:blank"></iframe>
            </div>
        </section>
    </main>

    <footer class="bg-white border-t border-slate-100 pt-24 pb-12 px-6">
        <div class="max-w-7xl mx-auto grid md:grid-cols-4 gap-12 mb-20">
            <div class="col-span-2">
                <span class="text-3xl font-black tracking-tighter mb-6 block">RecetaPp</span>
                <p class="text-slate-400 text-lg max-w-sm">Redefiniendo la forma en que el mundo descubre la cocina a través de inteligencia colectiva.</p>
            </div>
            <div>
                <h4 class="font-bold mb-6">Explorar</h4>
                <ul class="space-y-4 text-slate-500">
                    <li><a href="#" class="hover:text-orange-500 transition">Recetas Pro</a></li>
                    <li><a href="#" class="hover:text-orange-500 transition">Cursos Online</a></li>
                    <li><a href="#" class="hover:text-orange-500 transition">Ingredientes</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-bold mb-6">Comunidad</h4>
                <div class="flex gap-4">
                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center hover:bg-orange-500 hover:text-white transition-all cursor-pointer"><i data-lucide="instagram"></i></div>
                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center hover:bg-orange-500 hover:text-white transition-all cursor-pointer"><i data-lucide="youtube"></i></div>
                </div>
            </div>
        </div>
        <div class="max-w-7xl mx-auto pt-8 border-t border-slate-50 text-center text-slate-400 text-sm">
            &copy; 2024 RecetaPp | Todos los derechos reservados.
        </div>
    </footer>

<script>
    async function cargarDatos() {
        /*const params = new URLSearchParams(window.location.search);
        const idCapturado = params.get('id') || params.get('video_id');

        if (!idCapturado) {
            console.error("No se encontró ID en la URL");
            return;
        }*/
         const urlParams = new URLSearchParams(window.location.search);
         const idVideo = urlParams.get('id');

         if (!idVideo) {
             window.location.href = 'index.html'; // Redirigir si no hay ID
        return;
        }

        try {
            /*const response = await fetch('./data/recetas.json');
            const datos = await response.json();
            const receta = datos.find(r => r.video_id === idCapturado);*/
            const workerUrl = `https://api-recetas.tu-usuario.workers.dev?id=${idVideo}`;
            const respuesta = await fetch(workerUrl);
            const recetaEncontrada = await respuesta.json();

            try {
        // Pedimos específicamente el ID al Worker
        const workerUrl = `https://api-recetas.tu-usuario.workers.dev?id=${idVideo}`;
        const respuesta = await fetch(workerUrl);
        const recetaEncontrada = await respuesta.json();

        if (recetaEncontrada && !recetaEncontrada.error) {
            // 1. Inyectamos el Schema para Google Adsense
            generarSchemaJSONLD(recetaEncontrada);
            
            // 2. Pintamos la interfaz (título, ingredientes, pasos)
            pintarInterfaz(recetaEncontrada);
        } else {
            console.error("Receta no encontrada");
        }
          } catch (e) {
           console.error("Error de conexión:", e);
         }






            if (receta) {
                // 1. Video
                const iframe = document.getElementById('videoFrame');
                iframe.src = (receta.url_iframe && receta.url_iframe !== "undefined") 
                             ? receta.url_iframe 
                             : `https://www.youtube.com/embed/${receta.video_id}`;

                // 2. Textos
                document.getElementById('tituloReceta').innerText = receta.titulo;
                document.getElementById('descripcionReceta').innerText = receta.descripcion || "";
                document.getElementById('categoriaReceta').innerText = receta.categoria || "Gourmet";
                document.getElementById('paisReceta').innerText = receta.pais || "Mundo";
                document.getElementById('tiempoReceta').innerText = receta.tiempo || "--";
                document.getElementById('dificultadReceta').innerText = receta.dificultad || "Fácil";

                // --- LÓGICA DE PERSISTENCIA DE CHECKBOXES ---
                const storageKey = `ingredientes_${idCapturado}`;
                // Recuperar estado guardado o crear uno nuevo
                let estadoIngredientes = JSON.parse(sessionStorage.getItem(storageKey)) || {};

                // 3. Renderizar Ingredientes
                const containerIng = document.getElementById('listaIngredientes');
                containerIng.innerHTML = (receta.ingredientes || []).map((ing, index) => {
                    const isChecked = estadoIngredientes[index] ? 'checked' : '';
                    return `
                    <label class="flex items-start gap-4 p-4 bg-white border border-slate-100 rounded-2xl cursor-pointer hover:shadow-sm transition group">
                        <div class="flex-shrink-0 mt-1">
                            <input type="checkbox" 
                                   data-index="${index}" 
                                   class="checkbox-custom w-5 h-5 accent-orange-500 rounded border-slate-300 cursor-pointer" 
                                   ${isChecked}>
                        </div>
                        <span class="text-slate-700 font-medium group-hover:text-orange-600 transition-colors">${ing}</span>
                    </label>
                `}).join('');

                // Event listener para guardar cambios
                containerIng.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = e.target.getAttribute('data-index');
                        estadoIngredientes[idx] = e.target.checked;
                        sessionStorage.setItem(storageKey, JSON.stringify(estadoIngredientes));
                    });
                });

                // 4. Pasos (Igual que antes)
                const containerPasos = document.getElementById('listaPasos');
                const pasos = receta.pasos_clave || receta.pasos || receta.preparacion || [];
                if (pasos && pasos.length > 0) {
                    containerPasos.innerHTML = pasos.map((paso, index) => `
                        <div class="flex gap-6 group">
                            <div class="flex-shrink-0 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold shadow-lg shadow-orange-100 group-hover:scale-110 transition-transform">
                                ${index + 1}
                            </div>
                            <div class="pt-1">
                                <p class="text-slate-600 text-lg leading-relaxed">${paso}</p>
                            </div>
                        </div>`).join('');
                } else {
                    containerPasos.innerHTML = `<p class="text-slate-400 italic">No hay pasos disponibles.</p>`;
                }

                lucide.createIcons();
            }
        } catch (error) {
            console.error("Error cargando receta:", error);
        }
    }
    window.onload = cargarDatos;
</script>
</body>
</html>